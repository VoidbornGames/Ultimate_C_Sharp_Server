#!/bin/bash
set -euo pipefail

# ============================================================
# UltimateServer â€“ Automated Installer
# Repository: VoidbornGames/UltimateServer
# Target: Ubuntu 22.04 / 24.04
# ============================================================

# -------------------------
# Configuration
# -------------------------
REPO="VoidbornGames/UltimateServer"
INSTALL_DIR="/var/UltimateServer"
RELEASE_FILE="UltimateServer.zip"
SERVICE_NAME="ultimateserver"
SERVER_BINARY="Server"
SERVER_ARGS="11001 11002 11003 11004"

# -------------------------
# Colors & helpers
# -------------------------
RED="\033[1;31m"
GREEN="\033[1;32m"
YELLOW="\033[1;33m"
BLUE="\033[1;34m"
RESET="\033[0m"

log()    { echo -e "${BLUE}[INFO]${RESET} $1"; }
success(){ echo -e "${GREEN}[OK]${RESET}   $1"; }
warn()   { echo -e "${YELLOW}[WARN]${RESET} $1"; }
error()  { echo -e "${RED}[FAIL]${RESET} $1"; exit 1; }

# -------------------------
# Banner
# -------------------------
clear
echo "============================================================"
echo "              UltimateServer Auto Installer"
echo "============================================================"
echo

# -------------------------
# 1. Root check
# -------------------------
if [[ "$EUID" -ne 0 ]]; then
  error "Please run as root (sudo ./install.sh)"
fi

success "Running as root"

# -------------------------
# 2. System dependencies
# -------------------------
log "Updating system packages..."
apt update -y

log "Installing required packages..."
apt install -y \
  wget unzip ufw jq \
  software-properties-common \
  ca-certificates lsb-release apt-transport-https \
  certbot nginx

# PHP (unchanged, explicitly supported)
if ! grep -q "^deb .*ondrej/php" /etc/apt/sources.list /etc/apt/sources.list.d/* 2>/dev/null; then
  log "Adding PHP repository..."
  add-apt-repository -y ppa:ondrej/php
  apt update -y
fi

apt install -y \
  php8.3 php8.3-cli php8.3-fpm php8.3-mysql \
  php8.3-curl php8.3-xml php8.3-mbstring \
  php8.3-zip php8.3-gd php8.3-bcmath

success "Dependencies installed"

# -------------------------
# 3. Installation directory
# -------------------------
log "Preparing installation directory..."
mkdir -p "$INSTALL_DIR"
cd "$INSTALL_DIR"

# -------------------------
# 4. Download latest release
# -------------------------
log "Fetching latest release metadata..."
API_JSON=$(wget -qO- "https://api.github.com/repos/${REPO}/releases/latest" || true)

LATEST_URL=$(echo "$API_JSON" | jq -r ".assets[] | select(.name==\"${RELEASE_FILE}\") | .browser_download_url" 2>/dev/null || true)

if [[ -z "$LATEST_URL" || "$LATEST_URL" == "null" ]]; then
  error "Release asset '${RELEASE_FILE}' not found"
fi

log "Downloading UltimateServer release..."
wget --show-progress -O "$RELEASE_FILE" "$LATEST_URL"

[[ -s "$RELEASE_FILE" ]] || error "Downloaded file is empty"

success "Release downloaded"

# -------------------------
# 5. Extract files
# -------------------------
log "Extracting files..."
unzip -o "$RELEASE_FILE" -d "$INSTALL_DIR" >/dev/null
rm -f "$RELEASE_FILE"

chmod +x "${INSTALL_DIR}/${SERVER_BINARY}"

success "Files installed"

# -------------------------
# 6. Firewall configuration
# -------------------------
log "Configuring firewall rules..."
ufw allow 11001/tcp
ufw allow 11002
ufw allow 11003/udp
ufw allow 11004
ufw reload || warn "UFW reload skipped"

success "Firewall configured"

# -------------------------
# 7. systemd service
# -------------------------
log "Creating systemd service..."

cat > "/etc/systemd/system/${SERVICE_NAME}.service" <<EOF
[Unit]
Description=UltimateServer
After=network.target

[Service]
Type=simple
WorkingDirectory=/var/UltimateServer
ExecStart=/var/UltimateServer/Server 11001 11002 11003 11004
# This tells systemd to send SIGINT first, which your app handles gracefully
KillSignal=SIGINT 
# Give our application 60 seconds to shut down gracefully before systemd kills it
TimeoutStopSec=60 
Restart=always
RestartSec=5
User=root
Environment=DOTNET_CLI_TELEMETRY_OPTOUT=1

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now "$SERVICE_NAME"

success "Service started and enabled"

# -------------------------
# Done
# -------------------------
echo
echo "============================================================"
echo " UltimateServer installation completed successfully"
echo "------------------------------------------------------------"
echo " Location : ${INSTALL_DIR}"
echo " Service  : systemctl status ${SERVICE_NAME}"
echo " Binary   : ${INSTALL_DIR}/${SERVER_BINARY}"
echo " Ports    : ${SERVER_ARGS}"
echo "============================================================"
echo
