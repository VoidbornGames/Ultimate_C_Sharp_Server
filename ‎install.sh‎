#!/bin/bash
set -e

# === CONFIG ===
REPO="VoidbornGames/UltimateServer"
INSTALL_DIR="/var/UltimateServer"
RELEASE_FILE="UltimateServer.zip"
DOTNET_CMD="dotnet Server.dll 11001 11002 11003 11004"

echo "==== üß© UltimateServer Auto Installer ===="

# 1Ô∏è‚É£ Root check
if [ "$EUID" -ne 0 ]; then
  echo "‚ùå Please run as root (sudo ./install.sh)"
  exit 1
fi

# 2Ô∏è‚É£ Update and install dependencies
echo "[1/6] Updating system packages..."
apt update -y
apt install -y wget unzip ufw dotnet-sdk-8.0 software-properties-common ca-certificates lsb-release apt-transport-https certbot nginx
add-apt-repository ppa:ondrej/php
apt update
apt install -y php8.3 php8.3-cli php8.3-fpm php8.3-mysql php8.3-curl php8.3-xml php8.3-mbstring php8.3-zip php8.3-gd php8.3-bcmath

# 3Ô∏è‚É£ Create installation directory
echo "[2/6] Creating installation directory..."
mkdir -p "$INSTALL_DIR"
cd "$INSTALL_DIR"

# 4Ô∏è‚É£ Fetch latest release download URL
echo "[3/6] Downloading latest release from GitHub..."
LATEST_URL=$(wget -qO- "https://api.github.com/repos/$REPO/releases/latest" \
  | grep "browser_download_url" \
  | grep "$RELEASE_FILE" \
  | cut -d '"' -f 4)

if [ -z "$LATEST_URL" ]; then
  echo "‚ùå Could not find release file '$RELEASE_FILE' in the latest release."
  echo "Make sure you uploaded it as a GitHub release asset."
  exit 1
fi

wget -O "$RELEASE_FILE" "$LATEST_URL"

# 5Ô∏è‚É£ Extract and clean up
echo "[4/6] Extracting files..."
unzip -o "$RELEASE_FILE" -d "$INSTALL_DIR" >/dev/null
rm -f "$RELEASE_FILE"

# 6Ô∏è‚É£ Configure firewall
echo "[5/6] Configuring firewall rules..."
ufw allow 11001/tcp
ufw allow 11002
ufw allow 11003/udp
ufw allow 11004
ufw reload

# 7Ô∏è‚É£ Create systemd service (auto-start on boot)
echo "[6/6] Running the server..."
cd $INSTALL_DIR
dotnet Server.dll 11001 11002 11003 11004

echo "‚úÖ UltimateServer installation complete!"
echo "----------------------------------------"
echo "Installed at: $INSTALL_DIR"
echo "Ports:        11001, 11002, 11003, 11004"
echo "----------------------------------------"
